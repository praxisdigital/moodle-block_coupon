define("block_coupon/templates/rearrange-area",["exports","jquery","jqueryui","core_form/modalform","block_coupon/templates/service"],(function(_exports,_jquery,jqui,_modalform,Service){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),jqui=_interopRequireWildcard(jqui),_modalform=_interopRequireDefault(_modalform),Service=_interopRequireWildcard(Service);class RearrangeArea{constructor(selector){_defineProperty(this,"_node",null),_defineProperty(this,"COUPON_REF_POINT_TOPLEFT",0),_defineProperty(this,"COUPON_REF_POINT_TOPCENTER",1),_defineProperty(this,"COUPON_REF_POINT_TOPRIGHT",2),_defineProperty(this,"PIXELSINMM",3.779527559055),this._node=(0,_jquery.default)(selector),this._setEvents()}_getElementHTML(elementid){const templateid=this._node.attr("data-templateid");return Service.getElementHTML(templateid,elementid)}_saveElement(elementid){const templateid=this._node.attr("data-templateid"),inputs=(0,_jquery.default)("#editelementform").serializeArray();return Service.saveElement(templateid,elementid,inputs)}_setEvents(){this._node.on("click",".element",this._editElement.bind(this))}async _editElement(event){var elementid=event.currentTarget.dataset.id;const modalForm=new _modalform.default({formClass:"block_coupon\\template\\edit_element_dform",args:{id:elementid},modalConfig:{title:"walla"}});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,this._modalAfterSave.bind(this)),modalForm.show()}_modalAfterSave(data){let element=data.detail;this._getElementHTML(element.id).done(function(html){var elementNode=this._node.find("#element-"+element.id),refpoint=parseInt(element.refpoint),refpointClass="";refpoint==this.COUPON_REF_POINT_TOPLEFT?refpointClass="refpoint-left":refpoint==this.COUPON_REF_POINT_TOPCENTER?refpointClass="refpoint-center":refpoint==this.COUPON_REF_POINT_TOPRIGHT&&(refpointClass="refpoint-right"),elementNode.empty().append(html),elementNode.removeClass(),elementNode.addClass("element "+refpointClass),elementNode.data("refpoint",refpoint);var posx=element.posx,posy=element.posy;this._setPosition(element.id,refpoint,posx,posy)}.bind(this))}_setPosition(elementid,refpoint,posx,posy){var element=(0,_jquery.default)("#element-"+elementid),pdf=(0,_jquery.default)("#pdf");posx=pdf.offset().left+posx*this.PIXELSINMM,posy=pdf.offset().top+posy*this.PIXELSINMM;var nodewidth=parseFloat(element.width()),maxwidth=element.width()*this.PIXELSINMM;switch(maxwidth&&nodewidth>maxwidth&&(nodewidth=maxwidth),refpoint){case this.COUPON_REF_POINT_TOPCENTER:posx-=nodewidth/2;break;case this.COUPON_REF_POINT_TOPRIGHT:posx=posx-nodewidth+2}element.offset({left:posx,top:posy})}}class Rearrange{constructor(templateid,page,elements){_defineProperty(this,"templateid",0),_defineProperty(this,"page",[]),_defineProperty(this,"elements",[]),_defineProperty(this,"pdfx",0),_defineProperty(this,"pdfy",0),_defineProperty(this,"pdfwidth",0),_defineProperty(this,"pdfheight",0),_defineProperty(this,"elementxy",0),_defineProperty(this,"pdfleftboundary",0),_defineProperty(this,"pdfrightboundary",0),_defineProperty(this,"pixelsinmm",3.779527559055),this.templateid=templateid,this.page=page,this.elements=elements,this.setPdfDimensions(),this.setBoundaries(),this.setpositions(),this.createevents(),window.addEventListener("resize",this.checkWindownResize.bind(this))}setpositions(){for(var key in this.elements){var element=this.elements[key],el=document.querySelector("#element-"+element.id);if(null!=el){var posx=this.pdfx+element.posx*this.pixelsinmm,posy=this.pdfy+element.posy*this.pixelsinmm,nodewidth=el.getBoundingClientRect().width,maxwidth=element.width*this.pixelsinmm;switch(maxwidth&&nodewidth>maxwidth&&(nodewidth=maxwidth),element.refpoint){case"1":posx-=nodewidth/2;break;case"2":posx=posx-nodewidth+2}(0,_jquery.default)("#element-"+element.id).offset({left:posx,top:posy})}}}setPdfDimensions(){const el=document.querySelector("#pdf"),cr=el.getBoundingClientRect(),offset=(0,_jquery.default)(el).offset();this.pdfx=offset.left,this.pdfy=offset.top,this.pdfwidth=parseFloat(cr.width),this.pdfheight=parseFloat(cr.height)}setBoundaries(){this.pdfleftboundary=this.pdfx,this.page.leftmargin&&(this.pdfleftboundary+=parseInt(this.page.leftmargin*this.pixelsinmm,10)),this.pdfrightboundary=this.pdfx+this.pdfwidth,this.page.rightmargin&&(this.pdfrightboundary-=parseInt(this.page.rightmargin*this.pixelsinmm,10))}checkWindownResize(){this.setPdfDimensions(),this.setBoundaries(),this.setpositions()}createevents(){(0,_jquery.default)(".savepositionsbtn [type=submit]").on("click",function(e){e.preventDefault(),this.savepositions(e).then((function(){var formnode=e.currentTarget.closest("form"),baseurl=formnode.getAttribute("action"),pageinput=formnode.querySelector("[name=pid]");if(pageinput){var pageid=pageinput.value;window.location=baseurl+"?pid="+pageid}else{var templateid=formnode.querySelector("[name=tid]").value;window.location=baseurl+"?tid="+templateid}}))}.bind(this)),(0,_jquery.default)(".applypositionsbtn [type=submit]").on("click",function(e){e.preventDefault(),this.savepositions(e)}.bind(this));var pixelsinmm=this.pixelsinmm,target=(0,_jquery.default)("#pdf .element");target.draggable({snap:!1,snapMode:"inner",snapTolerance:10,containment:(0,_jquery.default)("#pdf")}),target.on("dragstart",(function(e){(0,_jquery.default)(e.currentTarget).addClass("isdragged")})).on("dragstop",(function(e){var el=(0,_jquery.default)(e.currentTarget),page=el.closest("#pdf"),refpoint=parseInt((0,_jquery.default)(this).data("refpoint")),offset=refpoint?parseInt((0,_jquery.default)(this).width())*refpoint/2:0,left=(el.offset().left-page.offset().left+offset)/pixelsinmm,top=(el.offset().top-page.offset().top)/pixelsinmm;setTimeout((function(){el.removeClass("isdragged")}),100),Service.updateElementPositions(page.data("templateid"),[{id:el.data("id"),posx:Math.round(parseFloat(left)),posy:Math.round(parseFloat(top))}])}))}isoutofbounds(el){var cr=el.getBoundingClientRect(),offset=(0,_jquery.default)(el).offset(),nodewidth=parseFloat(cr.width),nodeheight=parseFloat(cr.height),left=offset.left,right=left+nodewidth,top=offset.top,bottom=top+nodeheight;const pdf=document.querySelector("#pdf"),poffset=(0,_jquery.default)(pdf).offset();return this.pdfx=poffset.left,this.pdfy=poffset.top,left<this.pdfleftboundary||right>this.pdfrightboundary||(top<this.pdfy||bottom>this.pdfy+this.pdfheight)}savepositions(){var values=[];const offset=(0,_jquery.default)("#pdf").offset();for(var key in this.pdfx=offset.left,this.pdfy=offset.top,this.elements){var element=this.elements[key],el=(0,_jquery.default)("#element-"+element.id);if(0!==el.length){var eloffset=el.offset(),posx=eloffset.left-this.pdfx,posy=eloffset.top-this.pdfy,refpoint=el.data("refpoint"),nodewidth=parseFloat(el.width());switch(refpoint){case"1":posx+=nodewidth/2;break;case"2":posx+=nodewidth}values.push({id:element.id,posx:Math.round(parseFloat(posx/this.pixelsinmm)),posy:Math.round(parseFloat(posy/this.pixelsinmm))})}}Service.updateElementPositions(this.templateid,values)}}var _default={init:function(selector,templateid,page,elements){new Rearrange(templateid,page,elements),new RearrangeArea(selector)}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=rearrange-area.min.js.map